<!DOCTYPE html>
<html>
<head>
  <title>4人即時聊天</title>
  <link rel="stylesheet" href="/static/style.css">
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body>
  <div class="container">
    <h1>多人即時聊天測試</h1>
    <div class="input-group">
      <input type="text" id="username" placeholder="名字" value="玩家1">
      <input type="text" id="room" placeholder="房間" value="test123">
      <button onclick="joinRoom()">加入</button>
    </div>
    <div id="chat-box"></div>
    <div class="input-group">
      <input type="text" id="message" placeholder="輸入訊息..." onkeypress="if(event.key==='Enter') sendMessage()">
      <button onclick="sendMessage()">發送</button>
    </div>
    <div id="users">在線：0 人</div>
  </div>

  <script>
    const socket = io();
    let currentRoom = '', username = '';

    function joinRoom() {
      username = document.getElementById('username').value.trim() || '匿名';
      currentRoom = document.getElementById('room').value.trim() || 'test123';
      socket.emit('join', { username, room: currentRoom });
    }

    function sendMessage() {
      const msg = document.getElementById('message').value.trim();
      if (!msg || !currentRoom) return;
      socket.emit('send_message', { username, room: currentRoom, message: msg });
      document.getElementById('message').value = '';
    }

    function addMessage(user, text) {
      const div = document.createElement('div');
      div.className = 'message';
      div.innerHTML = `<strong>${user}:</strong> ${text}`;
      document.getElementById('chat-box').appendChild(div);
      div.scrollIntoView();
    }

    // 關鍵！接收 user_list
    socket.on('user_list', names => {
      document.getElementById('users').innerText = `在線：${names.length} 人 (${names.join(', ')})`;
    });

    socket.on('status', msg => addMessage('系統', msg));
    socket.on('new_message', data => addMessage(data.username, data.message));

    // 自動加入
    window.onload = () => setTimeout(joinRoom, 500);
  </script>
</body>
</html>
